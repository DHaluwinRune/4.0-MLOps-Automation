name: azure-mlops

on:
  # Je kan hem manueel starten
  workflow_dispatch:
    inputs:
      run_training:
        description: 'Run Azure ML training pipeline'
        required: false
        type: boolean
        default: true
      deploy_to_kubernetes:
        description: 'Deploy Docker image to Kubernetes'
        required: false
        type: boolean
        default: true
  # Optioneel: ook draaien bij push op main
  push:
    branches:
      - main

# Handig: globale omgevingsvariabelen
env:
  AZURE_RESOURCE_GROUP: mlops-rune
  AZURE_WORKSPACE_NAME: rune-mlops-ws
  AZURE_LOCATION: westeurope

jobs:
  azure-pipeline:
    if: inputs.run_training == true
    runs-on: ubuntu-24.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure -- Create compute (if needed)
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            az extension add --name ml -y
            az configure --defaults group=$AZURE_RESOURCE_GROUP workspace=$AZURE_WORKSPACE_NAME location=$AZURE_LOCATION

            echo "Checking if compute 'rune-mlops-ci' already exists..."

            if az ml compute show \
              --name rune-mlops-ci \
              --resource-group $AZURE_RESOURCE_GROUP \
              --workspace-name $AZURE_WORKSPACE_NAME >/dev/null 2>&1; then

              echo "Compute 'rune-mlops-ci' already exists, skipping creation."

            else
              echo "Compute not found, creating it now..."
              az ml compute create \
                --file ./environment/compute.yaml \
                --resource-group $AZURE_RESOURCE_GROUP \
                --workspace-name $AZURE_WORKSPACE_NAME
            fi

      - name: Azure -- Start Compute (ensure rune-mlops-ci running)
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            az extension add --name ml -y
            az configure --defaults group=$AZURE_RESOURCE_GROUP workspace=$AZURE_WORKSPACE_NAME location=$AZURE_LOCATION

            echo "Checking compute state for 'rune-mlops-ci'..."

            STATE=$(az ml compute show \
              --name rune-mlops-ci \
              --resource-group $AZURE_RESOURCE_GROUP \
              --workspace-name $AZURE_WORKSPACE_NAME \
              --query "properties.state" -o tsv 2>/dev/null || echo "UNKNOWN")

            echo "Current compute state: '$STATE'"

            if [ "$STATE" != "Running" ]; then
              echo "Compute is not Running, trying to start it..."
              az ml compute start \
                --name rune-mlops-ci \
                --resource-group $AZURE_RESOURCE_GROUP \
                --workspace-name $AZURE_WORKSPACE_NAME || echo "Start command failed (maybe already running)."
            else
              echo "Compute already Running."
            fi


      - name: Azure -- Environments & Components (looped)
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            az extension add --name ml -y
            az configure --defaults group=$AZURE_RESOURCE_GROUP workspace=$AZURE_WORKSPACE_NAME location=$AZURE_LOCATION

            # === Environments (gebruik jouw bestanden) ===
            for ENV in preprocessing.yaml training.yaml; do
              az ml environment create \
                --file "./environment/${ENV}" \
                --resource-group $AZURE_RESOURCE_GROUP \
                --workspace-name $AZURE_WORKSPACE_NAME
            done

            # === Components ===
            for COMPONENT_FILE in \
              "./components/dataprep/dataprep.yaml" \
              "./components/dataprep/data_split.yaml" \
              "./components/training/training.yaml"
            do
              az ml component create \
                --file "${COMPONENT_FILE}" \
                --resource-group $AZURE_RESOURCE_GROUP \
                --workspace-name $AZURE_WORKSPACE_NAME
            done

      - name: Azure -- Pipeline Run
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            az extension add --name ml -y
            az configure --defaults group=$AZURE_RESOURCE_GROUP workspace=$AZURE_WORKSPACE_NAME location=$AZURE_LOCATION
            az ml job create \
              --file ./pipelines/animals-classification.yaml \
              --resource-group $AZURE_RESOURCE_GROUP \
              --workspace-name $AZURE_WORKSPACE_NAME \
              --stream \
              --set name=animals-classification-${{ github.sha }}-${{ github.run_id }}

      - name: Azure -- Stop Compute (cleanup)
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            az extension add --name ml -y
            az configure --defaults group=$AZURE_RESOURCE_GROUP workspace=$AZURE_WORKSPACE_NAME location=$AZURE_LOCATION
            az ml compute stop \
              --name rune-mlops-ci \
              --resource-group $AZURE_RESOURCE_GROUP \
              --workspace-name $AZURE_WORKSPACE_NAME

        continue-on-error: true

  download:
    needs: azure-pipeline
    runs-on: ubuntu-24.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure -- Download Model
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            az extension add --name ml -y
            az configure --defaults group=$AZURE_RESOURCE_GROUP workspace=$AZURE_WORKSPACE_NAME location=$AZURE_LOCATION

            VERSION=$(az ml model list \
              --name animal-classification \
              --resource-group $AZURE_RESOURCE_GROUP \
              --workspace-name $AZURE_WORKSPACE_NAME \
              --query "[0].version" -o tsv)

            echo "Latest model version: $VERSION"

            az ml model download \
              --name animal-classification \
              --version $VERSION \
              --resource-group $AZURE_RESOURCE_GROUP \
              --workspace-name $AZURE_WORKSPACE_NAME \
              --download-path ./inference/animal-classification

      - name: Docker -- Upload API code from Inference
        uses: actions/upload-artifact@v4.3.3
        with:
          name: docker-config
          path: inference

  deploy:
    needs: download
    runs-on: self-hosted

    steps:
      - name: Docker -- Gather Tags
        id: docker-meta-data
        uses: docker/metadata-action@v5.5.1
        with:
          images: |
            ghcr.io/${{ toLower(github.repository_owner) }}/mlops-animals-api
          tags: |
            type=ref,event=branch
            type=sha

      - name: Docker -- Login to GHCR
        uses: docker/login-action@v3.2.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker -- Download API Code for Inference
        uses: actions/download-artifact@v4.1.7
        with:
          name: docker-config
          path: inference

      - name: Docker Build and push
        id: docker_build
        uses: docker/build-push-action@v5.3.0
        with:
          context: ./inference
          push: true
          tags: ${{ steps.docker-meta-data.outputs.tags }}

  kubernetes-deploy:
    needs: deploy
    if: inputs.deploy_to_kubernetes == true
    runs-on: self-hosted

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # Optioneel: als je KUBECONFIG uit een secret haalt
      # - name: Configure kubeconfig
      #   shell: powershell
      #   run: |
      #     $env:KUBECONFIG = "${{ secrets.KUBECONFIG_PATH }}"
      #     echo "Using kubeconfig at $env:KUBECONFIG"

      - name: Apply Kubernetes deployment and service
        run: |
          kubectl apply -f kubernetes/animals-api-deployment.yaml

      - name: Check pods
        run: |
          kubectl get pods -n default
